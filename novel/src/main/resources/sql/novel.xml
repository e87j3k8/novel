<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="novel">
	<!-- 작품 목록 -->
	<select id="novel.getProductList" resultClass="novelVo">
		select
			tn.id as novelId,
			tu.nick as authorNm,
			tn.title as title,
			(select tg.genreNm from tb_genrecode tg where tg.id=tn.genre1) as genre,
			ifnull((select tg.genreNm from tb_genrecode tg where tg.id=tn.genre2),'') as genre2,
			ifnull(sum(a.`view`),0) as viewAll,
			date_format(ti.regDt,'%Y-%m/%d %h:%i') as regDt,
			if(date_format(ti.regDt,'%Y-%m/%d %h:%i') between date_format(date_sub(now(), INTERVAL 1 day) ,'%Y-%m/%d %h:%i') and date_format(now(),'%Y-%m/%d %h:%i'),true,false) as isNew
		from tb_novel tn
		inner join tb_user tu on tn.author = tu.id
		inner join tb_items ti on tn.id=ti.novelId
		left join (
			select
				tv.itemId,
				count(tv.itemId) as `view`
			from tb_view tv
			group by itemId
		) a
		on ti.id = a.itemId
		where 1=1
		group by tn.id
		order by ti.regDt desc
		<isNotEmpty property="page">
		limit #page#, 5
		</isNotEmpty>
	</select>
	
	<select id="novel.rankingTop" parameterClass="hashMap" resultClass="novelVo">
		select
			tn.id as novelId,
			title as title,
			ifnull(sum(a.view),0) as `viewAll`
		from tb_novel tn
		inner join tb_items ti on tn.id=ti.novelId
		left join (
			select
				tv.itemId,
				count(tv.itemId) as `view`
			from tb_view tv
			group by itemId
		) a on ti.id = a.itemId
		group by tn.id
		order by `viewAll` desc,tn.id
		<isNotEmpty property="rank">
		limit #rank#
		</isNotEmpty>
	</select>
</sqlMap>